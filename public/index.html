<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ‹çˆ±å æœ‰æ¬²æµ‹è¯• Â· å¯çˆ±ç‰ˆï¼ˆé‚€è¯·åˆ¶ï¼‰</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fff7fb; --card:#fff; --text:#333; --muted:#6b7280;
      --primary:#ff9bd2; --primary-2:#c6b5ff; --accent:#a7f3d0;
      --radius:20px; --shadow:0 12px 30px rgba(0,0,0,.12)
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(800px 500px at -10% -10%, #ffe4f4 0, transparent 60%),
                 radial-gradient(900px 650px at 110% 0%, #eef2ff 0, transparent 60%),
                 var(--bg);
      color:var(--text);
      font:16px/1.7 Nunito, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .container{max-width:820px; margin:0 auto; padding:20px}
    header{position:sticky; top:0; background:rgba(255,255,255,.7); backdrop-filter: blur(8px); border-bottom:1px solid #f3e8ff}
    nav{display:flex; justify-content:space-between; align-items:center; height:60px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:900}
    .logo{width:28px; height:28px; border-radius:8px; background:conic-gradient(from 180deg, var(--primary), var(--primary-2), var(--accent)); box-shadow:var(--shadow)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,.95)); border:1px solid #f3e8ff; border-radius:var(--radius); box-shadow:var(--shadow); padding:22px}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 16px; border-radius:14px; border:1px solid #f3e8ff; color:#4b5563; background:#fff; cursor:pointer}
    .btn-primary{background:linear-gradient(135deg, var(--primary), var(--primary-2)); color:#fff; font-weight:900}
    .btn-danger{background:#fee2e2; border-color:#fecaca; color:#b91c1c}
    .muted{color:var(--muted)}
    .center{display:grid; place-items:center}
    .pill{display:inline-block; padding:6px 12px; border-radius:999px; background:#fef3ff; border:1px solid #f3e8ff; color:#7c3aed; font-size:12px; font-weight:700}
    .progress{height:10px; background:#f3e8ff; border-radius:999px; overflow:hidden}
    .progress > span{display:block; height:100%; background:linear-gradient(90deg, var(--primary), var(--primary-2)); width:0%}
    .options{display:grid; gap:12px; margin-top:14px}
    .option{padding:14px 16px; border-radius:14px; border:1px solid #f3e8ff; background:#fff; transition:.15s transform, .15s box-shadow}
    .option:hover{transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .qnum{font-weight:900; color:#a855f7}
    .big{font-size:26px; font-weight:900; letter-spacing:.3px}
    footer{padding:40px 0; color:#9ca3af; border-top:1px solid #f3e8ff; margin-top:28px}

    /* ç»“æœé¡µ */
    .result-card .score-wrap{display:grid; gap:10px; justify-items:center}
    .result-card .score{font-size:72px; font-weight:900; line-height:1;
      background:linear-gradient(135deg, var(--primary), var(--primary-2));
      -webkit-background-clip:text; background-clip:text; color:transparent}
    .result-card .badge{display:inline-block; margin-top:4px; padding:6px 10px; border-radius:999px; font-weight:900; font-size:13px}
    .badge-low{background:#ecfeff; color:#047481; border:1px solid #a5f3fc}
    .badge-mid{background:#f0f9ff; color:#075985; border:1px solid #bae6fd}
    .badge-high{background:#fff7ed; color:#9a3412; border:1px solid #fed7aa}
    .badge-very{background:#fef2f2; color:#991b1b; border:1px solid #fecaca}

    .meter{width:100%; max-width:520px}
    .meter .bar{height:16px; width:100%; background:#f3e8ff; border:1px solid #f3e8ff;
      border-radius:999px; overflow:hidden}
    .meter .bar > span{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--primary), var(--primary-2))}
    .meter .ticks{display:flex; justify-content:space-between; font-size:12px; color:#6b7280; margin-top:6px}
    .meter .ticks span{min-width:60px; text-align:center}

    .legend{margin-top:14px; padding:12px; border:1px dashed #f3e8ff; border-radius:14px; background:#fff}
    .legend li{margin:6px 0}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <nav>
        <div class="brand"><span class="logo"></span>æ‹çˆ±å æœ‰æ¬²æµ‹è¯•</div>
        <span class="pill">é‚€è¯·åˆ¶</span>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Step 1: éªŒè¯ç /é‚€è¯·ç  -->
    <section id="step-invite" class="card">
      <div class="center">
        <div class="big">ğŸ”’ è¾“å…¥éªŒè¯ç </div>
        <p class="muted">æ¯ä¸ªéªŒè¯ç ä»…é™ä¸€äººä½¿ç”¨ï¼Œç”¨äºè¿›å…¥æœ¬æµ‹è¯•ã€‚</p>
      </div>
      <form id="inviteForm" style="display:grid; gap:12px; justify-items:center; margin-top:10px">
        <input id="code" required placeholder="ä¾‹å¦‚ï¼ša1B2c3D4" style="width:260px; padding:12px 14px; border-radius:12px; border:1px solid #f3e8ff; background:#fff; color:#374151">
        <button class="btn btn-primary" type="submit">ç»‘å®šå¹¶ç»§ç»­</button>
        <span id="inviteMsg" class="muted"></span>
      </form>
    </section>

    <!-- Step 2: ä»‹ç»é¡µï¼ˆå³ä½¿å·²ç™»å½•ä¹Ÿå…ˆåˆ°è¿™é‡Œï¼‰ -->
    <section id="step-intro" class="card" style="display:none">
      <div class="center" style="gap:8px">
        <div class="big">ğŸ° è½»æ¾è¯´æ˜</div>
        <p class="muted" style="text-align:center">
          æœ¬æµ‹è¯•åŒ…å« 10 é¢˜ï¼Œä¸€æ¬¡åªæ˜¾ç¤ºä¸€é“ã€‚<br>
          é‡‡ç”¨äº”ç‚¹é‡è¡¨ï¼šéå¸¸ä¸åŒæ„ / ä¸åŒæ„ / ä¸­ç«‹ / åŒæ„ / éå¸¸åŒæ„ã€‚<br>
          å®Œæˆåä¼šç»™å‡º <strong>0â€“100 åˆ†</strong> çš„ç›´è§‚å¾—åˆ†ä¸åˆ†æã€‚
        </p>
      </div>
      <div style="display:flex; gap:8px; justify-content:center; margin-top:10px">
        <button class="btn btn-primary" id="startBtn">å¼€å§‹æµ‹è¯•</button>
        <button class="btn btn-danger" id="logoutBtn">æ›´æ¢éªŒè¯ç /é€€å‡º</button>
      </div>
    </section>

    <!-- Step 3: å•é¢˜æ¨¡å¼ -->
    <section id="step-quiz" class="card" style="display:none">
      <div style="display:grid; gap:12px">
        <div class="progress"><span id="bar"></span></div>
        <div><span class="qnum" id="qnum">Q1</span></div>
        <div id="qtext" class="big">é¢˜ç›®åŠ è½½ä¸­...</div>
        <div class="options" id="options"></div>
        <div class="muted" id="quizMsg"></div>
      </div>
    </section>

    <!-- Step 4: åˆ†æç»“æœï¼ˆç‹¬ç«‹ä¸€æ ï¼Œåˆ†æ•°å¤§ï¼‰ -->
    <section id="step-result" class="card result-card" style="display:none">
      <div class="score-wrap">
        <div class="big">ğŸ“Š ä½ çš„æ‹çˆ±å æœ‰æ¬²æŒ‡æ•°</div>
        <div class="score" id="score">0</div>
        <div id="scoreBadge" class="badge">ç­‰çº§</div>

        <div class="meter">
          <div class="bar"><span id="scoreBar"></span></div>
          <div class="ticks">
            <span>0ï¼ˆè‡ªç”±è‡ªåœ¨ï¼‰</span>
            <span>50ï¼ˆæ°åˆ°å¥½å¤„ï¼‰</span>
            <span>100ï¼ˆçˆ±åˆ°æè‡´ï¼‰</span>
          </div>
        </div>
      </div>

      <div id="advice" class="muted" style="margin-top:12px"></div>

      <ul class="legend">
        <li>0â€“25 åˆ†ï¼š<strong>è¾ƒä½ï¼ˆè‡ªç”±è‡ªåœ¨ï¼‰</strong> â€“ ç»™ä¼´ä¾£å……åˆ†è‡ªç”±ä¸ä¿¡ä»»ï¼ŒåŒæ—¶è®°å¾—è¡¨è¾¾æŠ•å…¥ã€‚</li>
        <li>26â€“50 åˆ†ï¼š<strong>é€‚ä¸­ï¼ˆæ°åˆ°å¥½å¤„ï¼‰</strong> â€“ å¹³è¡¡ä¿¡ä»»ä¸å…³æ³¨ï¼Œä¿æŒå¼€æ”¾æ²Ÿé€šã€‚</li>
        <li>51â€“75 åˆ†ï¼š<strong>è¾ƒå¼ºï¼ˆéœ€è¦æ³¨æ„ï¼‰</strong> â€“ ä¸ºå½¼æ­¤ä¿ç•™ç©ºé—´ï¼Œå­¦ä¼šç”¨â€œè¯´æ˜éœ€æ±‚â€æ›¿ä»£â€œæ§åˆ¶â€ã€‚</li>
        <li>76â€“100 åˆ†ï¼š<strong>å¼ºçƒˆ</strong> â€“ å¯èƒ½å¸¦æ¥å‹åŠ›ï¼Œå»ºè®®å¼ºåŒ–è¾¹ç•Œæ„Ÿä¸å®‰å…¨æ„Ÿå»ºè®¾ã€‚</li>
      </ul>

      <div style="display:flex; gap:8px; margin-top:12px; justify-content:center">
        <button class="btn" id="retry">å†æµ‹ä¸€æ¬¡</button>
        <button class="btn" id="viewLast">æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡ç»“æœ</button>
        <button class="btn btn-danger" id="logoutBtn2">æ›´æ¢éªŒè¯ç /é€€å‡º</button>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">Â© <span id="year"></span> æ‹çˆ±å æœ‰æ¬²æµ‹è¯• Â· å¯çˆ±ç‰ˆ</div>
  </footer>

<script>
document.getElementById('year').textContent = new Date().getFullYear();
const el = id => document.getElementById(id);
const show = (id, v=true) => el(id).style.display = v ? '' : 'none';

// è¿›å…¥ç«™ç‚¹æ—¶ï¼šå¦‚æœå·²ç™»å½•ï¼Œä¸ç›´æ¥å¼€æµ‹ï¼Œå…ˆåˆ°â€œä»‹ç»æµ‹è¯•â€é¡µ
fetch('/api/me').then(r=>r.json()).then(d=>{
  if (d.ok && d.me) {
    show('step-invite', false);
    show('step-intro', true);
  }
}).catch(()=>{});

// ç»‘å®šéªŒè¯ç 
el('inviteForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  el('inviteMsg').textContent = 'æ­£åœ¨ç»‘å®š...';
  const code = el('code').value.trim();
  const res = await fetch('/api/claim-invite', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ code })
  });
  const d = await res.json();
  if (d.ok) {
    el('inviteMsg').textContent = 'æˆåŠŸï¼';
    show('step-invite', false);
    show('step-intro', true);
  } else {
    el('inviteMsg').textContent = 'å¤±è´¥ï¼š' + (d.error||'æœªçŸ¥é”™è¯¯');
  }
});

// ç™»å‡ºï¼ˆæ›´æ¢éªŒè¯ç ï¼‰
async function logoutAndBack(){
  await fetch('/api/logout', { method:'POST' });
  show('step-intro', false);
  show('step-result', false);
  show('step-quiz', false);
  show('step-invite', true);
}
el('logoutBtn')?.addEventListener('click', logoutAndBack);
el('logoutBtn2')?.addEventListener('click', logoutAndBack);

// é¢˜åº“ï¼ˆ10é¢˜ï¼‰
const ITEMS = [
  'æˆ‘ä¼šå¸Œæœ›ä¼´ä¾£æŠŠæ›´å¤šæ—¶é—´ç•™ç»™æˆ‘ã€‚',
  'å½“æˆ‘è”ç³»ä¸ä¸Šä¼´ä¾£æ—¶ï¼Œæˆ‘ä¼šéå¸¸ä¸å®‰ã€‚',
  'æˆ‘ç›¸ä¿¡ä¼´ä¾£åœ¨æˆ‘ä¸åœ¨æ—¶ä¹Ÿä¼šè‡ªå¾‹ã€‚',
  'å½“ä¼´ä¾£ä¸ä»–äººèµ°å¾—è¿‘æ—¶ï¼Œæˆ‘ä¼šæ„Ÿåˆ°å æœ‰æ¬²ã€‚',
  'æˆ‘åœ¨å…³ç³»ä¸­éœ€è¦ä¿æœ‰ä¸€å®šçš„ä¸ªäººç©ºé—´ã€‚',
  'å³ä½¿åœ¨äº²å¯†å…³ç³»é‡Œï¼Œæˆ‘ä¹Ÿå¸Œæœ›ä¿ç•™ç‹¬ç«‹çš„å†³å®šæƒã€‚',
  'å½“æˆ‘æ„Ÿè§‰è¢«å¿½è§†æ—¶ï¼Œä¼šæƒ³è¦æ›´å¼ºçš„æ§åˆ¶ã€‚',
  'æˆ‘å¸¸æ‹…å¿ƒä¼´ä¾£ä¼šå¦å®šæˆ–ç¦»å¼€æˆ‘ã€‚',
  'æˆ‘æ›´å€¾å‘äºå…ˆé€‰æ‹©ä¿¡ä»»è€Œéæ€€ç–‘ã€‚',
  'æˆ‘ä¸å–œæ¬¢å¯¹æ–¹è¿‡åº¦å¹²æ¶‰æˆ‘çš„æ—¥å¸¸å®‰æ’ã€‚'
];

const OPTIONS = [
  { label:'éå¸¸ä¸åŒæ„', value:1 },
  { label:'ä¸åŒæ„', value:2 },
  { label:'ä¸­ç«‹', value:3 },
  { label:'åŒæ„', value:4 },
  { label:'éå¸¸åŒæ„', value:5 },
];

// å…ˆæ˜¾ç¤ºä»‹ç»é¡µ â†’ ç‚¹â€œå¼€å§‹æµ‹è¯•â€æ‰è¿›å…¥é—®å·
el('startBtn').addEventListener('click', startQuiz);

let idx = 0;
let answers = [];

function startQuiz(){
  show('step-intro', false);
  show('step-quiz', true);
  idx = 0; answers = [];
  renderQuestion();
}

function renderQuestion(){
  el('qnum').textContent = `Q${idx+1} / ${ITEMS.length}`;
  el('qtext').textContent = ITEMS[idx];
  const bar = Math.round((idx) / ITEMS.length * 100);
  el('bar').style.width = bar + '%';
  const optWrap = el('options');
  optWrap.innerHTML = '';
  OPTIONS.forEach(o=>{
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'option';
    btn.textContent = o.label;
    btn.addEventListener('click', ()=> choose(o.value));
    optWrap.appendChild(btn);
  });
}

function choose(val){
  answers[idx] = val;
  if (idx < ITEMS.length - 1){
    idx++;
    renderQuestion();
  } else {
    submitAll();
  }
}

function renderResultPayload(payload){
  const s = payload.scores?.composite100 ?? 0;
  el('score').textContent = s;
  el('scoreBar').style.width = s + '%';

  const badge = el('scoreBadge');
  badge.className = 'badge';
  if (s >= 76) { badge.classList.add('badge-very'); badge.textContent = 'å¼ºçƒˆ'; }
  else if (s >= 51) { badge.classList.add('badge-high'); badge.textContent = 'è¾ƒå¼ºï¼ˆéœ€è¦æ³¨æ„ï¼‰'; }
  else if (s >= 26) { badge.classList.add('badge-mid'); badge.textContent = 'é€‚ä¸­ï¼ˆæ°åˆ°å¥½å¤„ï¼‰'; }
  else { badge.classList.add('badge-low'); badge.textContent = 'è¾ƒä½ï¼ˆè‡ªç”±è‡ªåœ¨ï¼‰'; }

  el('advice').textContent = payload.analysis;
}

async function submitAll(){
  const res = await fetch('/api/submit', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ answers })
  });
  const d = await res.json();
  if (!d.ok){ el('quizMsg').textContent = 'æäº¤å¤±è´¥ï¼š' + (d.error||'æœªçŸ¥é”™è¯¯'); return; }
  show('step-quiz', false);
  show('step-result', true);
  renderResultPayload(d);
}

el('retry').addEventListener('click', ()=>{
  show('step-result', false);
  show('step-intro', true); // å›åˆ°ä»‹ç»ï¼Œå†å¼€å§‹
});

el('viewLast').addEventListener('click', async ()=>{
  const d = await fetch('/api/result').then(r=>r.json());
  if (d.ok && d.result) {
    show('step-quiz', false); show('step-result', true);
    renderResultPayload({ scores: d.result.scores, analysis: d.result.analysis });
  }
});
</script>
</body>
</html>
